# 记录

记录是Burn保存状态的方式。与大多数其他框架相比，Burn拥有自己先进的保存机制，允许在后端之间互操作，且运行时错误最少。Burn决定创建自己的保存格式有多个原因。

首先，Rust有[serde](https://serde.rs/)，这是一个极其完善的序列化和反序列化库，它还支持Hugging Face开发的`safetensors`格式。如果使用得当，所有验证都在反序列化时完成，这消除了编写验证代码的需要。由于Burn中的模块是用配置创建的，它们无法实现序列化和反序列化。这就是为什么创建了记录系统：允许您独立于使用的后端快速保存模块状态，同时仍然为您提供所有可能的灵活性，以在模块中包含任何不可序列化的字段。

**为什么不使用safetensors？**

[`safetensors`](https://github.com/huggingface/safetensors)使用带有JSON文件格式的serde，仅支持序列化和反序列化张量。Burn中的记录系统让您有可能序列化任何类型，这对于保存状态的优化器非常有用，也适用于您可能拥有的任何非标准、前沿的建模需求。此外，记录系统通过使用Rust类型执行自动精度转换，使其更加可靠，减少手动操作。

需要注意的是，`safetensors`格式使用"安全"一词来区别于容易受到Python代码注入攻击的Pickle。在我们这边，仅仅使用Rust这一事实就已经确保了不可能发生代码注入。如果您的存储机制不处理数据损坏，您可能更喜欢执行校验和验证的记录器（即任何带有Gzip压缩的记录器）。

## 记录器

记录器独立于后端，以精度和格式序列化记录。请注意，格式也可以是内存中的，允许您直接将记录保存到字节中。

| 记录器               | 格式                   | 压缩 |
| ---------------------- | ------------------------ | ----------- |
| DefaultFileRecorder    | 文件 - 命名MessagePack | 无        |
| NamedMpkFileRecorder   | 文件 - 命名MessagePack | 无        |
| NamedMpkGzFileRecorder | 文件 - 命名MessagePack | Gzip        |
| BinFileRecorder        | 文件 - 二进制            | 无        |
| BinGzFileRecorder      | 文件 - 二进制            | Gzip        |
| JsonGzFileRecorder     | 文件 - Json              | Gzip        |
| PrettyJsonFileRecorder | 文件 - 美化Json       | Gzip        |
| BinBytesRecorder       | 内存中 - 二进制       | 无        |

每个记录器都支持与训练或推理中使用的精度解耦的精度设置。这些设置允许您定义用于序列化和反序列化的浮点和整数类型。

| 设置                   | 浮点精度 | 整数精度 |
| ------------------------- | --------------- | ----------------- |
| `DoublePrecisionSettings` | `f64`           | `i64`             |
| `FullPrecisionSettings`   | `f32`           | `i32`             |
| `HalfPrecisionSettings`   | `f16`           | `i16`             |

请注意，将记录加载到模块中时，类型转换会自动处理，因此您不会遇到错误。唯一关键的方面是序列化和反序列化时使用相同的记录器；否则，您将遇到加载错误。

**您应该使用哪个记录器？**

- 如果您想要快速的序列化和反序列化，请选择不带压缩的记录器。在不压缩的情况下，文件大小最小的是二进制格式；否则，可以使用命名MessagePack。
- 如果您想要保存模型以供存储，可以使用压缩，但避免使用二进制格式，因为它可能不向后兼容。
- 如果您想要调试模型权重，可以使用美化JSON格式。
- 如果您想要使用`no-std`部署，请使用内存中的二进制格式，并将字节包含在编译代码中。

有关保存和加载记录的示例，请查看[保存和加载模型](../saving-and-loading.md)。